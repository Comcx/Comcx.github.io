<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-06-25 Thu 14:34 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MIT6.828 Lab 1</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Comcx" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="org-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="org-themes/styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="org-themes/styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="org-themes/styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="org-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="org-themes/styles/readtheorg/js/readtheorg.js"></script>
<style>pre.src{background:#343131;color:white;} </style>
<style> #content{max-width:1800px;}</style>
<style> p{max-width:800px;}</style>
<link rel="icon" type="image/x-icon" href="../images/digimon-icon.png" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">MIT6.828 Lab 1</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgaee76d6">1. Software and Environment Setup</a>
<ul>
<li><a href="#org4e29401">1.1. Pull ubuntu from docker-hub and make a dockerfile</a></li>
<li><a href="#org38b1182">1.2. Install patched QEMU</a>
<ul>
<li><a href="#org9aa14ff">1.2.1. Pitfalls</a></li>
</ul>
</li>
<li><a href="#org64d4e90">1.3. Pull JOS repository</a></li>
</ul>
</li>
<li><a href="#org2a45407">2. Part 1: PC Bootstrap</a>
<ul>
<li><a href="#org8674563">2.1. Exercise 1</a></li>
<li><a href="#org625697c">2.2. The PC's Physical Address Space</a></li>
<li><a href="#orgb208feb">2.3. Exercise 2</a></li>
</ul>
</li>
<li><a href="#org486b35b">3. Part 2: The Boot Loader</a>
<ul>
<li><a href="#org754ac76">3.1. Exercise 3</a>
<ul>
<li><a href="#org7bec37f">3.1.1. GDB useful instructions</a></li>
<li><a href="#org8d63b8e">3.1.2. Trace 0x7C00</a></li>
<li><a href="#org825a4af">3.1.3. Trace bootmain and readect</a></li>
<li><a href="#orgd9042a2">3.1.4. Questions</a></li>
</ul>
</li>
<li><a href="#orgdb44ca9">3.2. Loading the kernel</a>
<ul>
<li><a href="#org9afc553">3.2.1. Exercise 5</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8c64b51">4. Part 3: The Kernel</a></li>
</ul>
</div>
</div>
<p>
I want to review MIT6.828 labs and homework&#x2026;
This is still essential for me to make a better pl someday :)
</p>

<ul class="org-ul">
<li>Reference</li>
</ul>
<p>
<a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/">MIT6.828 2018 Lab 1</a>
</p>

<div id="outline-container-orgaee76d6" class="outline-2">
<h2 id="orgaee76d6"><span class="section-number-2">1</span> Software and Environment Setup</h2>
<div class="outline-text-2" id="text-1">
<p>
The origin course uses <span class="underline">athena</span> and a patched <span class="underline">qemu</span> .
I do not want to install a new virtual OS or have a new computer or
ruin my current computer.
Therefore, I decide to use <span class="underline">docker</span> and make a virtual environment which is
effcient and light-weight.
</p>

<p>
The process is a little tough though&#x2026;
</p>
</div>

<div id="outline-container-org4e29401" class="outline-3">
<h3 id="org4e29401"><span class="section-number-3">1.1</span> Pull ubuntu from docker-hub and make a dockerfile</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-shell">$ docker pull ubuntu:18.04
</pre>
</div>

<ul class="org-ul">
<li>Dockerfile</li>
</ul>
<pre class="example">
FROM ubuntu:18.04

RUN apt-get update \
    &amp;&amp; apt-get install -y \
    sudo \
    git \
    g++ \
    emacs \
    make \
    gcc-multilib \
    &amp;&amp; useradd --create-home --no-log-init --shell /bin/bash comcx \
    &amp;&amp; adduser comcx sudo \
    &amp;&amp; echo 'comcx:mimawei0' | chpasswd

USER comcx
WORKDIR /home/comcx

</pre>

<ul class="org-ul">
<li>Build</li>
</ul>
<pre class="example">
$ docker build -t oslab .
</pre>
<p>
Now we have a very small environment prototype which will be fixed into our experiment space later:)
</p>

<p>
Run the following command into the container!
</p>
<pre class="example">
$ docker run -it oslab bash
</pre>
</div>
</div>

<div id="outline-container-org38b1182" class="outline-3">
<h3 id="org38b1182"><span class="section-number-3">1.2</span> Install patched QEMU</h3>
<div class="outline-text-3" id="text-1-2">
<p>
We need to firstly pull the patched qemu following reference page.
<a href="https://pdos.csail.mit.edu/6.828/2018/tools.html">Tool page</a>
</p>
<div class="org-src-container">
<pre class="src src-shell">$ git clone https://github.com/mit-pdos/6.828-qemu.git qemu
$ cd qemu
$ ./configure --disable-kvm --disable-werror --disable-sdl <span style="color: #ffd700;">[</span>--prefix=PFX<span style="color: #ffd700;">]</span> <span style="color: #ffd700;">[</span>--target-list=<span style="color: #ad7fa8; font-style: italic;">"i386-softmmu x86_64-softmmu"</span><span style="color: #ffd700;">]</span>
$ make &amp;&amp; make install
</pre>
</div>
</div>

<div id="outline-container-org9aa14ff" class="outline-4">
<h4 id="org9aa14ff"><span class="section-number-4">1.2.1</span> Pitfalls</h4>
<div class="outline-text-4" id="text-1-2-1">
<ul class="org-ul">
<li>Executing "./configure &#x2013;disable-kvm &#x2026;" 
<ul class="org-ul">
<li>ERROR: Python not found. Use &#x2013;python=/path/to/python</li>
<li>To fix: install python2.7, and add &#x2013;python=python2.7</li>

<li>ERROR: pkg-config binary 'pkg-config' not found</li>
<li>apt-get install -y pkg-config</li>

<li>ERROR: zlib check failed. Make sure to have the zlib libs and headers installed.</li>
<li>sudo apt-get install zlib1g-dev</li>

<li>ERROR: glib-2.12 gthread-2.0 is required to compile QEMU</li>
<li>sudo apt-get install libglib2.0-dev</li>
</ul></li>
</ul>

<p>
Finally, we are done.
</p>
</div>
</div>
</div>

<div id="outline-container-org64d4e90" class="outline-3">
<h3 id="org64d4e90"><span class="section-number-3">1.3</span> Pull JOS repository</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-shell">$ git clone https://pdos.csail.mit.edu/6.828/2018/jos.git lab
</pre>
</div>

<p>
Inside lab/, try <code>make qemu</code> ,if the program runs, then our basic experiment space is now ready.
</p>
<pre class="example">
$ docker commit &lt;container&gt; mit6.828
</pre>
</div>
</div>
</div>

<div id="outline-container-org2a45407" class="outline-2">
<h2 id="org2a45407"><span class="section-number-2">2</span> Part 1: PC Bootstrap</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org8674563" class="outline-3">
<h3 id="org8674563"><span class="section-number-3">2.1</span> Exercise 1</h3>
<div class="outline-text-3" id="text-2-1">
<blockquote>
<p>
Familiarize yourself with the assembly language materials available on the 6.828 reference page. 
You don't have to read them now, but you'll almost certainly want to refer to some of this material when reading and writing x86 assembly.
</p>

<p>
We do recommend reading the section "The Syntax" in Brennan's Guide to Inline Assembly. 
It gives a good (and quite brief) description of the AT&amp;T assembly syntax we'll be using with the GNU assembler in JOS.
</p>
</blockquote>

<p>
<a href="http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html">Brennan's Guide to Inline Assembly</a> is nice for both intel and AT&amp;T syntax(I prefer intel).
The <span class="underline">PCASM book</span> helps me a lot!
</p>

<p>
Finally, I am comfortable with most of assembly programs, but still lack experience and have some problems at use of
<code>in</code> and <code>out</code> commands&#x2026;
</p>
</div>
</div>

<div id="outline-container-org625697c" class="outline-3">
<h3 id="org625697c"><span class="section-number-3">2.2</span> The PC's Physical Address Space</h3>
<div class="outline-text-3" id="text-2-2">
<pre class="example">
+------------------+  &lt;- 0xFFFFFFFF (4GB)
|      32-bit      |
|  memory mapped   |
|     devices      |
|                  |
/\/\/\/\/\/\/\/\/\/\

/\/\/\/\/\/\/\/\/\/\
|                  |
|      Unused      |
|                  |
+------------------+  &lt;- depends on amount of RAM
|                  |
|                  |
| Extended Memory  |
|                  |
|                  |
+------------------+  &lt;- 0x00100000 (1MB)
|     BIOS ROM     |
+------------------+  &lt;- 0x000F0000 (960KB)
|  16-bit devices, |
|  expansion ROMs  |
+------------------+  &lt;- 0x000C0000 (768KB)
|   VGA Display    |
+------------------+  &lt;- 0x000A0000 (640KB)
|                  |
|    Low Memory    |
|                  |
+------------------+  &lt;- 0x00000000
</pre>
<p>
This general picture of memory is important.
</p>

<p>
The layout exposes design compromise due to back compatibility.
To allow old PCs of 16bits, we still maintain the layout of 0x0 ~ 0x100000(old 8086 has 1MB space)
</p>

<p>
The BIOS ROM is first loaded into memory and then be executed when a computer powers on.
Let's inspect how BIOS is loaded and executed and eventually die out&#x2026;
</p>

<p>
Simulate our qemu!
The following line:
</p>
<pre class="example">
[f000:fff0] 0xffff0:	ljmp   $0xf000,$0xe05b
</pre>
<p>
is GDB's disassembly of the first instruction to be executed. From this output you can conclude a few things:
</p>

<ul class="org-ul">
<li>The IBM PC starts executing at physical address 0x000ffff0, which is at the very top of the 64KB area reserved for the ROM BIOS.</li>
<li>The PC starts executing with CS = 0xf000 and IP = 0xfff0.</li>
<li>The first instruction to be executed is a jmp instruction, which jumps to the segmented address CS = 0xf000 and IP = 0xe05b.</li>
</ul>

<p>
Well this looks weird, why at 0xffff0? why have to first execute at 0xffff0 and immediately jump to 0xfe05b?
Firstly, the BIOS in a PC is "hard-wired" to the physical address range 0x000f0000-0x000fffff, 
this design ensures that the BIOS always gets control of the machine first after power-up or any system restart.
Second, on processor reset, the (simulated) processor enters real mode and sets CS to 0xf000 and the IP to 0xfff0, 
so that execution begins at that (CS:IP) segment address.
</p>
</div>
</div>

<div id="outline-container-orgb208feb" class="outline-3">
<h3 id="orgb208feb"><span class="section-number-3">2.3</span> Exercise 2</h3>
<div class="outline-text-3" id="text-2-3">
<blockquote>
<p>
Use GDB's si (Step Instruction) command to trace into the ROM BIOS for a few more instructions, 
and try to guess what it might be doing. 
</p>

<p>
You might want to look at Phil Storrs I/O Ports Description, 
as well as other materials on the 6.828 reference materials page. 
No need to figure out all the details - just the general idea of what the BIOS is doing first.
</p>
</blockquote>
<p>
OK, just the general idea:)
</p>

<pre class="example">
The target architecture is assumed to be i8086
[f000:fff0]    0xffff0:	ljmp   $0xf000,$0xe05b
0x0000fff0 in ?? ()
+ symbol-file obj/kern/kernel
(gdb) si
[f000:e05b]    0xfe05b:	cmpl   $0x0,%cs:0x6ac8
0x0000e05b in ?? ()
(gdb) si
[f000:e062]    0xfe062:	jne    0xfd2e1
0x0000e062 in ?? ()
(gdb) si
[f000:e066]    0xfe066:	xor    %dx,%dx
0x0000e066 in ?? ()
(gdb) si
[f000:e068]    0xfe068:	mov    %dx,%ss
0x0000e068 in ?? ()
(gdb) 
...
</pre>
<p>
When the BIOS runs, it sets up an interrupt descriptor table and initializes various devices such as the VGA display. 
This is where the "Starting SeaBIOS" message you see in the QEMU window comes from.
</p>
</div>
</div>
</div>

<div id="outline-container-org486b35b" class="outline-2">
<h2 id="org486b35b"><span class="section-number-2">3</span> Part 2: The Boot Loader</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org754ac76" class="outline-3">
<h3 id="org754ac76"><span class="section-number-3">3.1</span> Exercise 3</h3>
<div class="outline-text-3" id="text-3-1">
<blockquote>
<p>
Take a look at the lab tools guide, especially the section on GDB commands. 
Even if you're familiar with GDB, this includes some esoteric GDB commands that are useful for OS work.
</p>

<p>
Set a breakpoint at address 0x7c00, which is where the boot sector will be loaded. 
Continue execution until that breakpoint. Trace through the code in boot/boot.S, 
using the source code and the disassembly file obj/boot/boot.asm to keep track of where you are. 
Also use the x/i command in GDB to disassemble sequences of instructions in the boot loader, 
and compare the original boot loader source code with both the disassembly in obj/boot/boot.asm and GDB.
</p>

<p>
Trace into bootmain() in boot/main.c, and then into readsect(). 
Identify the exact assembly instructions that correspond to each of the statements in readsect(). 
Trace through the rest of readsect() and back out into bootmain(), 
and identify the begin and end of the for loop that reads the remaining sectors of the kernel from the disk. 
Find out what code will run when the loop is finished, set a breakpoint there, and continue to that breakpoint. 
Then step through the remainder of the boot loader.
</p>
</blockquote>
</div>

<div id="outline-container-org7bec37f" class="outline-4">
<h4 id="org7bec37f"><span class="section-number-4">3.1.1</span> GDB useful instructions</h4>
<div class="outline-text-4" id="text-3-1-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Ctrl-c</td>
<td class="org-left">Halt the machine</td>
</tr>

<tr>
<td class="org-left">continue</td>
<td class="org-left">Continue execution until the next breakpoint or Ctrl-c</td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">same as continue</td>
</tr>

<tr>
<td class="org-left">stepi</td>
<td class="org-left">Execute one machine instruction</td>
</tr>

<tr>
<td class="org-left">si</td>
<td class="org-left">same as stepi</td>
</tr>

<tr>
<td class="org-left">b function</td>
<td class="org-left">Set a breakpoint at the given function or line</td>
</tr>

<tr>
<td class="org-left">b <a href="line">line</a></td>
<td class="org-left">same as above</td>
</tr>

<tr>
<td class="org-left">breakpoint</td>
<td class="org-left">as above</td>
</tr>

<tr>
<td class="org-left">b *addr</td>
<td class="org-left">Set a breakpoint at the EIP addr</td>
</tr>

<tr>
<td class="org-left">set print pretty</td>
<td class="org-left">Enable pretty-printing of arrays and structs</td>
</tr>

<tr>
<td class="org-left">info registers</td>
<td class="org-left">Print the general purpose registers, eip, eflags, and the segment selectors</td>
</tr>

<tr>
<td class="org-left">x/Nx addr</td>
<td class="org-left">Display a hex dump of N words starting at virtual address addr. If N is omitted, it defaults to 1</td>
</tr>

<tr>
<td class="org-left">x/Ni addr</td>
<td class="org-left">Display the N assembly instructions starting at addr</td>
</tr>

<tr>
<td class="org-left">symbol-file file</td>
<td class="org-left">Switch to symbol file file</td>
</tr>

<tr>
<td class="org-left">thread n</td>
<td class="org-left">focus to thread n</td>
</tr>

<tr>
<td class="org-left">info threads</td>
<td class="org-left">List all threads</td>
</tr>
</tbody>
</table>

<p>
Mostly, we will only use <code>c</code> and <code>b</code> and <code>x/N</code> .
</p>
</div>
</div>

<div id="outline-container-org8d63b8e" class="outline-4">
<h4 id="org8d63b8e"><span class="section-number-4">3.1.2</span> Trace 0x7C00</h4>
<div class="outline-text-4" id="text-3-1-2">
<pre class="example">
(gdb) b *0x7C00
Breakpoint 1 at 0x7c00
(gdb) c
Continuing.
[   0:7c00] =&gt; 0x7c00:	cli    

Breakpoint 1, 0x00007c00 in ?? ()
(gdb) x/i 0x7c00
=&gt; 0x7c00:	cli    
(gdb) (gdb) x/21i 0x7c00
=&gt; 0x7c00:	cli    
   0x7c01:	cld    
   0x7c02:	xor    %ax,%ax
   0x7c04:	mov    %ax,%ds
   0x7c06:	mov    %ax,%es
   0x7c08:	mov    %ax,%ss
   0x7c0a:	in     $0x64,%al
   0x7c0c:	test   $0x2,%al
   0x7c0e:	jne    0x7c0a
   0x7c10:	mov    $0xd1,%al
   0x7c12:	out    %al,$0x64
   0x7c14:	in     $0x64,%al
   0x7c16:	test   $0x2,%al
   0x7c18:	jne    0x7c14
   0x7c1a:	mov    $0xdf,%al
   0x7c1c:	out    %al,$0x60
   0x7c1e:	lgdtw  0x7c64
   0x7c23:	mov    %cr0,%eax
   0x7c26:	or     $0x1,%eax
   0x7c2a:	mov    %eax,%cr0
   0x7c2d:	ljmp   $0x8,$0x7c32
...
</pre>
<p>
The first few lines from 0x7c00 is just the same as code in <i>boot.S</i> .
There are some codes need to focus on.
</p>
<ol class="org-ol">
<li><p>
<code>ljmp $0x8,$0x7c32</code>
The original assembly code is <code>ljmp    $PROT_MODE_CSEG, $protcseg</code> where
<code>.set PROT_MODE_CSEG, 0x8         # kernel code segment selector</code>. 
The GDT code is:
</p>
<pre class="example">
   gdt:
     SEG_NULL                              # null seg
     SEG(STA_X|STA_R, 0x0, 0xffffffff)     # code seg
     SEG(STA_W, 0x0, 0xffffffff)           # data seg
</pre>
<p>
Here we can see that the logical addr <code>0x8</code> is mapped to <code>0x0</code>.
Therefore although we have GDT, the following code we're using is still mapped
directly to %eip.
</p></li>

<li><p>
Let's focus on bootmain next&#x2026; 
</p>
<pre class="example">
   (gdb) x/5i 0x7c40
      0x7c40:	mov    $0x7c00,%sp
      0x7c43:	add    %al,(%bx,%si)
      0x7c45:	call   0x7d13
      0x7c48:	add    %al,(%bx,%si)
      0x7c4a:	jmp    0x7c4a
</pre>
<p>
The origin is
</p>
<pre class="example">
   # Set up the stack pointer and call into C.
    movl    $start, %esp
    call bootmain

   # If bootmain returns (it shouldn't), loop.
  spin:
    jmp spin
</pre>
<p>
Since we are in assembly, we need to set %esp by hand to <code>0x7c00(function call conventions)</code>.
<code>bootmain</code> is at <code>0x7d13</code>.
</p>
<ul class="org-ul">
<li><p>
What does <code>add    %al,(%bx,%si)</code> do here?
</p>

<p>
it could be a bunch of data that the de-compiler is having trouble with&#x2026;
more likely, its just the header or footer information that comes with every executable&#x2026;
</p></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org825a4af" class="outline-4">
<h4 id="org825a4af"><span class="section-number-4">3.1.3</span> Trace bootmain and readect</h4>
<div class="outline-text-4" id="text-3-1-3">
<ul class="org-ul">
<li>bootmain code</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold;">bootmain</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">void</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
        <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">Proghdr</span> *<span style="color: #ff6347; font-weight: bold;">ph</span>, *<span style="color: #ff6347; font-weight: bold;">eph</span>;

        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">read 1st page off disk                                               </span>
        readseg<span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">uint32_t</span><span style="color: #ffa500;">)</span> ELFHDR, SECTSIZE*8, 0<span style="color: #00bfff;">)</span>;

        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">is this a valid ELF?                                                 </span>
        <span style="color: #729fcf; font-weight: bold;">if</span> <span style="color: #00bfff;">(</span>ELFHDR-&gt;e_magic != ELF_MAGIC<span style="color: #00bfff;">)</span>
                <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234; font-weight: bold;">bad</span>;

        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">load each program segment (ignores ph flags)                         </span>
        ph = <span style="color: #00bfff;">(</span><span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">Proghdr</span> *<span style="color: #00bfff;">)</span> <span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">uint8_t</span> *<span style="color: #ffa500;">)</span> ELFHDR + ELFHDR-&gt;e_phoff<span style="color: #00bfff;">)</span>;
        eph = ph + ELFHDR-&gt;e_phnum;
        <span style="color: #729fcf; font-weight: bold;">for</span> <span style="color: #00bfff;">(</span>; ph &lt; eph; ph++<span style="color: #00bfff;">)</span>
                <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">p_pa is the load address of this segment (as well            </span>
                <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">as the physical address)                                     </span>
                readseg<span style="color: #00bfff;">(</span>ph-&gt;p_pa, ph-&gt;p_memsz, ph-&gt;p_offset<span style="color: #00bfff;">)</span>;

        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">call the entry point from the ELF header                             </span>
        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">note: does not return!                                               </span>
        <span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">void</span> <span style="color: #ff7f50;">(</span>*<span style="color: #ff7f50;">)(</span><span style="color: #8ae234; font-weight: bold;">void</span><span style="color: #ff7f50;">)</span><span style="color: #ffa500;">)</span> <span style="color: #ffa500;">(</span>ELFHDR-&gt;e_entry<span style="color: #ffa500;">)</span><span style="color: #00bfff;">)()</span>;

<span style="color: #8ae234; font-weight: bold;">bad</span>:
        outw<span style="color: #00bfff;">(</span>0x8A00, 0x8A00<span style="color: #00bfff;">)</span>;
        outw<span style="color: #00bfff;">(</span>0x8A00, 0x8E00<span style="color: #00bfff;">)</span>;
        <span style="color: #729fcf; font-weight: bold;">while</span> <span style="color: #00bfff;">(</span>1<span style="color: #00bfff;">)</span>
                <span style="color: #888a85; font-style: italic;">/* </span><span style="color: #888a85; font-style: italic;">do nothing </span><span style="color: #888a85; font-style: italic;">*/</span>;
<span style="color: #ffd700;">}</span>

</pre>
</div>
<p>
Later we will figure out where the kernel will be loaded.
</p>
<pre class="example">
(gdb) x/10i 0x7d15
=&gt; 0x7d15:	push   %ebp
   0x7d16:	mov    %esp,%ebp
   0x7d18:	push   %esi
   0x7d19:	push   %ebx
   0x7d1a:	push   $0x0
   0x7d1c:	push   $0x1000
   0x7d21:	push   $0x10000
   0x7d26:	call   0x7cdc
   0x7d2b:	add    $0xc,%esp
   0x7d2e:	cmpl   $0x464c457f,0x10000
...
</pre>
<p>
The for loop checks eph range each loop.
</p>
</div>
</div>

<div id="outline-container-orgd9042a2" class="outline-4">
<h4 id="orgd9042a2"><span class="section-number-4">3.1.4</span> Questions</h4>
<div class="outline-text-4" id="text-3-1-4">
<ul class="org-ul">
<li><p>
At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode?
</p>

<p>
At the point after <code>ljmp    $PROT_MODE_CSEG, $protcseg</code>.
Change %cr0 exactly causes the switch.
</p></li>
</ul>


<ul class="org-ul">
<li><p>
What is the last instruction of the boot loader executed, and what is the first instruction of the kernel it just loaded?
</p>

<p>
Last instruction(if no fault): <code>((void (*)(void)) (ELFHDR-&gt;e_entry))();</code>.
First instruction of kernel: <code>movw $0x1234,0x472</code>.
</p></li>

<li><p>
Where is the first instruction of the kernel?
</p>

<p>
as above
</p></li>

<li><p>
How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? 
Where does it find this information?
</p>

<p>
from the variable <code>ELFHDR-&gt;e_phoff</code>.
</p></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgdb44ca9" class="outline-3">
<h3 id="orgdb44ca9"><span class="section-number-3">3.2</span> Loading the kernel</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org9afc553" class="outline-4">
<h4 id="org9afc553"><span class="section-number-4">3.2.1</span> Exercise 5</h4>
<div class="outline-text-4" id="text-3-2-1">
<blockquote>
<p>
Exercise 4. Read about programming with pointers in C. 
The best reference for the C language is The C Programming Language by Brian Kernighan and Dennis Ritchie (known as 'K&amp;R'). 
We recommend that students purchase this book (here is an Amazon Link) or find one of MIT's 7 copies.
</p>

<p>
Read 5.1 (Pointers and Addresses) through 5.5 (Character Pointers and Functions) in K&amp;R. 
Then download the code for pointers.c, run it, and make sure you understand where all of the printed values come from. 
In particular, make sure you understand where the pointer addresses in printed lines 1 and 6 come from, 
how all the values in printed lines 2 through 4 get there, and why the values printed in line 5 are seemingly corrupted.
</p>

<p>
There are other references on pointers in C (e.g., A tutorial by Ted Jensen that cites K&amp;R heavily), though not as strongly recommended.
</p>

<p>
Warning: Unless you are already thoroughly versed in C, do not skip or even skim this reading exercise. 
If you do not really understand pointers in C, you will suffer untold pain and misery in subsequent labs, 
and then eventually come to understand them the hard way. Trust us; you don't want to find out what "the hard way" is.
</p>
</blockquote>
<p>
The hard way&#x2026;emmmmm seems intereting (
</p>

<p>
I think I am already familiar with C pointers, but, just in case, Let's check knowledge by this exercise.
</p>

<p>
Code of <i>pointers.c</i>.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #729fcf;">#include</span> <span style="color: #ffd700; font-style: italic;">&lt;</span><span style="color: #ad7fa8; font-style: italic;">stdio.h</span><span style="color: #ffd700; font-style: italic;">&gt;</span>
<span style="color: #729fcf;">#include</span> <span style="color: #ffd700; font-style: italic;">&lt;</span><span style="color: #ad7fa8; font-style: italic;">stdlib.h</span><span style="color: #ffd700; font-style: italic;">&gt;</span>

<span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold;">f</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">void</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
    <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">a</span><span style="color: #00bfff;">[</span>4<span style="color: #00bfff;">]</span>;
    <span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347; font-weight: bold;">b</span> = malloc<span style="color: #00bfff;">(</span>16<span style="color: #00bfff;">)</span>;
    <span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347; font-weight: bold;">c</span>;
    <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">i</span>;

    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"1: a = %p, b = %p, c = %p\n"</span>, a, b, c<span style="color: #00bfff;">)</span>;

    c = a;
    <span style="color: #729fcf; font-weight: bold;">for</span> <span style="color: #00bfff;">(</span>i = 0; i &lt; 4; i++<span style="color: #00bfff;">)</span>
        a<span style="color: #00bfff;">[</span>i<span style="color: #00bfff;">]</span> = 100 + i;
    c<span style="color: #00bfff;">[</span>0<span style="color: #00bfff;">]</span> = 200;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"2: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span>,
           a<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span><span style="color: #00bfff;">)</span>;

    c<span style="color: #00bfff;">[</span>1<span style="color: #00bfff;">]</span> = 300;
    *<span style="color: #00bfff;">(</span>c + 2<span style="color: #00bfff;">)</span> = 301;
    3<span style="color: #00bfff;">[</span>c<span style="color: #00bfff;">]</span> = 302;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"3: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span>,
           a<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span><span style="color: #00bfff;">)</span>;

    c = c + 1;
    *c = 400;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"4: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span>,
           a<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span><span style="color: #00bfff;">)</span>;

    c = <span style="color: #00bfff;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #00bfff;">)</span> <span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ffa500;">)</span> c + 1<span style="color: #00bfff;">)</span>;
    *c = 500;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"5: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span>,
           a<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span><span style="color: #00bfff;">)</span>;

    b = <span style="color: #00bfff;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #00bfff;">)</span> a + 1;
    c = <span style="color: #00bfff;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #00bfff;">)</span> <span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ffa500;">)</span> a + 1<span style="color: #00bfff;">)</span>;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"6: a = %p, b = %p, c = %p\n"</span>, a, b, c<span style="color: #00bfff;">)</span>;
<span style="color: #ffd700;">}</span>

<span style="color: #8ae234; font-weight: bold;">int</span>
<span style="color: #edd400; font-weight: bold;">main</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">ac</span>, <span style="color: #8ae234; font-weight: bold;">char</span> **<span style="color: #ff6347; font-weight: bold;">av</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
    f<span style="color: #00bfff;">()</span>;
    <span style="color: #729fcf; font-weight: bold;">return</span> 0;
<span style="color: #ffd700;">}</span>

</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org8c64b51" class="outline-2">
<h2 id="org8c64b51"><span class="section-number-2">4</span> Part 3: The Kernel</h2>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Comcx</p>
<p class="date">Created: 2020-06-25 Thu 14:34</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
