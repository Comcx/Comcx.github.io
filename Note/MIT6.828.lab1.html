<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-06-29 Mon 23:52 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MIT6.828 Lab 1</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Comcx" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="org-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="org-themes/styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="org-themes/styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="org-themes/styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="org-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="org-themes/styles/readtheorg/js/readtheorg.js"></script>
<style>pre.src{background:#343131;color:white;} </style>
<style> #content{max-width:1800px;}</style>
<style> p{max-width:800px;}</style>
<link rel="icon" type="image/x-icon" href="../images/digimon-icon.png" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">MIT6.828 Lab 1</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1f197f5">1. Software and Environment Setup</a>
<ul>
<li><a href="#orgff16fc1">1.1. Pull ubuntu from docker-hub and make a dockerfile</a></li>
<li><a href="#org85d09ba">1.2. Install patched QEMU</a>
<ul>
<li><a href="#orge16fcd8">1.2.1. Pitfalls</a></li>
</ul>
</li>
<li><a href="#orgb0ef2f0">1.3. Pull JOS repository</a></li>
</ul>
</li>
<li><a href="#orgd4f8613">2. Part 1: PC Bootstrap</a>
<ul>
<li><a href="#org3789845">2.1. Exercise 1</a></li>
<li><a href="#orgfcca574">2.2. The PC's Physical Address Space</a></li>
<li><a href="#org6932729">2.3. Exercise 2</a></li>
</ul>
</li>
<li><a href="#orgd10fd1d">3. Part 2: The Boot Loader</a>
<ul>
<li><a href="#orgc58b143">3.1. Exercise 3</a>
<ul>
<li><a href="#orgf403c01">3.1.1. GDB useful instructions</a></li>
<li><a href="#org8d24aba">3.1.2. Trace 0x7C00</a></li>
<li><a href="#org21d3002">3.1.3. Trace bootmain and readect</a></li>
<li><a href="#org86c021d">3.1.4. Questions</a></li>
</ul>
</li>
<li><a href="#org2e74333">3.2. Loading the kernel</a>
<ul>
<li><a href="#orgeae11c7">3.2.1. Exercise 5</a></li>
<li><a href="#org01bcaa2">3.2.2. ELF format</a></li>
<li><a href="#org9bfdf99">3.2.3. Exercise 5</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org58bac30">4. Part 3: The Kernel</a>
<ul>
<li><a href="#org59edb95">4.1. Exercise 7</a></li>
<li><a href="#org3493dce">4.2. Formatted Printing to the Console</a>
<ul>
<li><a href="#org1365bea">4.2.1. Exercise 8</a></li>
<li><a href="#orgb274763">4.2.2. Explain the following code from <code>kern/console.c</code> .</a></li>
</ul>
</li>
<li><a href="#orgc1cc327">4.3. The Stack</a>
<ul>
<li><a href="#org5742cc4">4.3.1. Exercise 9</a></li>
<li><a href="#org65d6d34">4.3.2. Exercise 10</a></li>
<li><a href="#org6d6e509">4.3.3. Exercise 11</a></li>
<li><a href="#org7f53a61">4.3.4. Exercise 12</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org4e9f341">5. Epilogue</a></li>
</ul>
</div>
</div>
<p>
I want to review MIT6.828 labs and homework&#x2026;
This is still essential for me to make a better pl someday :)
</p>

<ul class="org-ul">
<li>Reference</li>
</ul>
<p>
<a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/">MIT6.828 2018 Lab 1</a>
</p>

<div id="outline-container-org1f197f5" class="outline-2">
<h2 id="org1f197f5"><span class="section-number-2">1</span> Software and Environment Setup</h2>
<div class="outline-text-2" id="text-1">
<p>
The origin course uses <span class="underline">athena</span> and a patched <span class="underline">qemu</span> .
I do not want to install a new virtual OS or have a new computer or
ruin my current computer.
Therefore, I decide to use <span class="underline">docker</span> and make a virtual environment which is
effcient and light-weight.
</p>

<p>
The process is a little tough though&#x2026;
</p>
</div>

<div id="outline-container-orgff16fc1" class="outline-3">
<h3 id="orgff16fc1"><span class="section-number-3">1.1</span> Pull ubuntu from docker-hub and make a dockerfile</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-shell">$ docker pull ubuntu:18.04
</pre>
</div>

<ul class="org-ul">
<li>Dockerfile</li>
</ul>
<pre class="example">
FROM ubuntu:18.04

RUN apt-get update \
    &amp;&amp; apt-get install -y \
    sudo \
    git \
    g++ \
    emacs \
    make \
    gcc-multilib \
    &amp;&amp; useradd --create-home --no-log-init --shell /bin/bash comcx \
    &amp;&amp; adduser comcx sudo \
    &amp;&amp; echo 'comcx:mimawei0' | chpasswd

USER comcx
WORKDIR /home/comcx

</pre>

<ul class="org-ul">
<li>Build</li>
</ul>
<pre class="example">
$ docker build -t oslab .
</pre>
<p>
Now we have a very small environment prototype which will be fixed into our experiment space later:)
</p>

<p>
Run the following command into the container!
</p>
<pre class="example">
$ docker run -it oslab bash
</pre>
</div>
</div>

<div id="outline-container-org85d09ba" class="outline-3">
<h3 id="org85d09ba"><span class="section-number-3">1.2</span> Install patched QEMU</h3>
<div class="outline-text-3" id="text-1-2">
<p>
We need to firstly pull the patched qemu following reference page.
<a href="https://pdos.csail.mit.edu/6.828/2018/tools.html">Tool page</a>
</p>
<div class="org-src-container">
<pre class="src src-shell">$ git clone https://github.com/mit-pdos/6.828-qemu.git qemu
$ cd qemu
$ ./configure --disable-kvm --disable-werror --disable-sdl <span style="color: #ffd700;">[</span>--prefix=PFX<span style="color: #ffd700;">]</span> <span style="color: #ffd700;">[</span>--target-list=<span style="color: #ad7fa8; font-style: italic;">"i386-softmmu x86_64-softmmu"</span><span style="color: #ffd700;">]</span>
$ make &amp;&amp; make install
</pre>
</div>
</div>

<div id="outline-container-orge16fcd8" class="outline-4">
<h4 id="orge16fcd8"><span class="section-number-4">1.2.1</span> Pitfalls</h4>
<div class="outline-text-4" id="text-1-2-1">
<ul class="org-ul">
<li>Executing "./configure &#x2013;disable-kvm &#x2026;" 
<ul class="org-ul">
<li>ERROR: Python not found. Use &#x2013;python=/path/to/python</li>
<li>To fix: install python2.7, and add &#x2013;python=python2.7</li>

<li>ERROR: pkg-config binary 'pkg-config' not found</li>
<li>apt-get install -y pkg-config</li>

<li>ERROR: zlib check failed. Make sure to have the zlib libs and headers installed.</li>
<li>sudo apt-get install zlib1g-dev</li>

<li>ERROR: glib-2.12 gthread-2.0 is required to compile QEMU</li>
<li>sudo apt-get install libglib2.0-dev</li>
</ul></li>
</ul>

<p>
Finally, we are done.
</p>
</div>
</div>
</div>

<div id="outline-container-orgb0ef2f0" class="outline-3">
<h3 id="orgb0ef2f0"><span class="section-number-3">1.3</span> Pull JOS repository</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-shell">$ git clone https://pdos.csail.mit.edu/6.828/2018/jos.git lab
</pre>
</div>

<p>
Inside lab/, try <code>make qemu</code> ,if the program runs, then our basic experiment space is now ready.
</p>
<pre class="example">
$ docker commit &lt;container&gt; mit6.828
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd4f8613" class="outline-2">
<h2 id="orgd4f8613"><span class="section-number-2">2</span> Part 1: PC Bootstrap</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org3789845" class="outline-3">
<h3 id="org3789845"><span class="section-number-3">2.1</span> Exercise 1</h3>
<div class="outline-text-3" id="text-2-1">
<blockquote>
<p>
Familiarize yourself with the assembly language materials available on the 6.828 reference page. 
You don't have to read them now, but you'll almost certainly want to refer to some of this material when reading and writing x86 assembly.
</p>

<p>
We do recommend reading the section "The Syntax" in Brennan's Guide to Inline Assembly. 
It gives a good (and quite brief) description of the AT&amp;T assembly syntax we'll be using with the GNU assembler in JOS.
</p>
</blockquote>

<p>
<a href="http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html">Brennan's Guide to Inline Assembly</a> is nice for both intel and AT&amp;T syntax(I prefer intel).
The <span class="underline">PCASM book</span> helps me a lot!
</p>

<p>
Finally, I am comfortable with most of assembly programs, but still lack experience and have some problems at use of
<code>in</code> and <code>out</code> commands&#x2026;
</p>
</div>
</div>

<div id="outline-container-orgfcca574" class="outline-3">
<h3 id="orgfcca574"><span class="section-number-3">2.2</span> The PC's Physical Address Space</h3>
<div class="outline-text-3" id="text-2-2">
<pre class="example">
+------------------+  &lt;- 0xFFFFFFFF (4GB)
|      32-bit      |
|  memory mapped   |
|     devices      |
|                  |
/\/\/\/\/\/\/\/\/\/\

/\/\/\/\/\/\/\/\/\/\
|                  |
|      Unused      |
|                  |
+------------------+  &lt;- depends on amount of RAM
|                  |
|                  |
| Extended Memory  |
|                  |
|                  |
+------------------+  &lt;- 0x00100000 (1MB)
|     BIOS ROM     |
+------------------+  &lt;- 0x000F0000 (960KB)
|  16-bit devices, |
|  expansion ROMs  |
+------------------+  &lt;- 0x000C0000 (768KB)
|   VGA Display    |
+------------------+  &lt;- 0x000A0000 (640KB)
|                  |
|    Low Memory    |
|                  |
+------------------+  &lt;- 0x00000000
</pre>
<p>
This general picture of memory is important.
</p>

<p>
The layout exposes design compromise due to back compatibility.
To allow old PCs of 16bits, we still maintain the layout of 0x0 ~ 0x100000(old 8086 has 1MB space)
</p>

<p>
The BIOS ROM is first loaded into memory and then be executed when a computer powers on.
Let's inspect how BIOS is loaded and executed and eventually die out&#x2026;
</p>

<p>
Simulate our qemu!
The following line:
</p>
<pre class="example">
[f000:fff0] 0xffff0:	ljmp   $0xf000,$0xe05b
</pre>
<p>
is GDB's disassembly of the first instruction to be executed. From this output you can conclude a few things:
</p>

<ul class="org-ul">
<li>The IBM PC starts executing at physical address 0x000ffff0, which is at the very top of the 64KB area reserved for the ROM BIOS.</li>
<li>The PC starts executing with CS = 0xf000 and IP = 0xfff0.</li>
<li>The first instruction to be executed is a jmp instruction, which jumps to the segmented address CS = 0xf000 and IP = 0xe05b.</li>
</ul>

<p>
Well this looks weird, why at 0xffff0? why have to first execute at 0xffff0 and immediately jump to 0xfe05b?
Firstly, the BIOS in a PC is "hard-wired" to the physical address range 0x000f0000-0x000fffff, 
this design ensures that the BIOS always gets control of the machine first after power-up or any system restart.
Second, on processor reset, the (simulated) processor enters real mode and sets CS to 0xf000 and the IP to 0xfff0, 
so that execution begins at that (CS:IP) segment address.
</p>
</div>
</div>

<div id="outline-container-org6932729" class="outline-3">
<h3 id="org6932729"><span class="section-number-3">2.3</span> Exercise 2</h3>
<div class="outline-text-3" id="text-2-3">
<blockquote>
<p>
Use GDB's si (Step Instruction) command to trace into the ROM BIOS for a few more instructions, 
and try to guess what it might be doing. 
</p>

<p>
You might want to look at Phil Storrs I/O Ports Description, 
as well as other materials on the 6.828 reference materials page. 
No need to figure out all the details - just the general idea of what the BIOS is doing first.
</p>
</blockquote>
<p>
OK, just the general idea:)
</p>

<pre class="example">
The target architecture is assumed to be i8086
[f000:fff0]    0xffff0:	ljmp   $0xf000,$0xe05b
0x0000fff0 in ?? ()
+ symbol-file obj/kern/kernel
(gdb) si
[f000:e05b]    0xfe05b:	cmpl   $0x0,%cs:0x6ac8
0x0000e05b in ?? ()
(gdb) si
[f000:e062]    0xfe062:	jne    0xfd2e1
0x0000e062 in ?? ()
(gdb) si
[f000:e066]    0xfe066:	xor    %dx,%dx
0x0000e066 in ?? ()
(gdb) si
[f000:e068]    0xfe068:	mov    %dx,%ss
0x0000e068 in ?? ()
(gdb) 
...
</pre>
<p>
When the BIOS runs, it sets up an interrupt descriptor table and initializes various devices such as the VGA display. 
This is where the "Starting SeaBIOS" message you see in the QEMU window comes from.
</p>
</div>
</div>
</div>

<div id="outline-container-orgd10fd1d" class="outline-2">
<h2 id="orgd10fd1d"><span class="section-number-2">3</span> Part 2: The Boot Loader</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgc58b143" class="outline-3">
<h3 id="orgc58b143"><span class="section-number-3">3.1</span> Exercise 3</h3>
<div class="outline-text-3" id="text-3-1">
<blockquote>
<p>
Take a look at the lab tools guide, especially the section on GDB commands. 
Even if you're familiar with GDB, this includes some esoteric GDB commands that are useful for OS work.
</p>

<p>
Set a breakpoint at address 0x7c00, which is where the boot sector will be loaded. 
Continue execution until that breakpoint. Trace through the code in boot/boot.S, 
using the source code and the disassembly file obj/boot/boot.asm to keep track of where you are. 
Also use the x/i command in GDB to disassemble sequences of instructions in the boot loader, 
and compare the original boot loader source code with both the disassembly in obj/boot/boot.asm and GDB.
</p>

<p>
Trace into bootmain() in boot/main.c, and then into readsect(). 
Identify the exact assembly instructions that correspond to each of the statements in readsect(). 
Trace through the rest of readsect() and back out into bootmain(), 
and identify the begin and end of the for loop that reads the remaining sectors of the kernel from the disk. 
Find out what code will run when the loop is finished, set a breakpoint there, and continue to that breakpoint. 
Then step through the remainder of the boot loader.
</p>
</blockquote>
</div>

<div id="outline-container-orgf403c01" class="outline-4">
<h4 id="orgf403c01"><span class="section-number-4">3.1.1</span> GDB useful instructions</h4>
<div class="outline-text-4" id="text-3-1-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Ctrl-c</td>
<td class="org-left">Halt the machine</td>
</tr>

<tr>
<td class="org-left">continue</td>
<td class="org-left">Continue execution until the next breakpoint or Ctrl-c</td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">same as continue</td>
</tr>

<tr>
<td class="org-left">stepi</td>
<td class="org-left">Execute one machine instruction</td>
</tr>

<tr>
<td class="org-left">si</td>
<td class="org-left">same as stepi</td>
</tr>

<tr>
<td class="org-left">b function</td>
<td class="org-left">Set a breakpoint at the given function or line</td>
</tr>

<tr>
<td class="org-left">b <a href="line">line</a></td>
<td class="org-left">same as above</td>
</tr>

<tr>
<td class="org-left">breakpoint</td>
<td class="org-left">as above</td>
</tr>

<tr>
<td class="org-left">b *addr</td>
<td class="org-left">Set a breakpoint at the EIP addr</td>
</tr>

<tr>
<td class="org-left">set print pretty</td>
<td class="org-left">Enable pretty-printing of arrays and structs</td>
</tr>

<tr>
<td class="org-left">info registers</td>
<td class="org-left">Print the general purpose registers, eip, eflags, and the segment selectors</td>
</tr>

<tr>
<td class="org-left">x/Nx addr</td>
<td class="org-left">Display a hex dump of N words starting at virtual address addr. If N is omitted, it defaults to 1</td>
</tr>

<tr>
<td class="org-left">x/Ni addr</td>
<td class="org-left">Display the N assembly instructions starting at addr</td>
</tr>

<tr>
<td class="org-left">symbol-file file</td>
<td class="org-left">Switch to symbol file file</td>
</tr>

<tr>
<td class="org-left">thread n</td>
<td class="org-left">focus to thread n</td>
</tr>

<tr>
<td class="org-left">info threads</td>
<td class="org-left">List all threads</td>
</tr>
</tbody>
</table>

<p>
Mostly, we will only use <code>c</code> and <code>b</code> and <code>x/N</code> .
</p>
</div>
</div>

<div id="outline-container-org8d24aba" class="outline-4">
<h4 id="org8d24aba"><span class="section-number-4">3.1.2</span> Trace 0x7C00</h4>
<div class="outline-text-4" id="text-3-1-2">
<pre class="example">
(gdb) b *0x7C00
Breakpoint 1 at 0x7c00
(gdb) c
Continuing.
[   0:7c00] =&gt; 0x7c00:	cli    

Breakpoint 1, 0x00007c00 in ?? ()
(gdb) x/i 0x7c00
=&gt; 0x7c00:	cli    
(gdb) (gdb) x/21i 0x7c00
=&gt; 0x7c00:	cli    
   0x7c01:	cld    
   0x7c02:	xor    %ax,%ax
   0x7c04:	mov    %ax,%ds
   0x7c06:	mov    %ax,%es
   0x7c08:	mov    %ax,%ss
   0x7c0a:	in     $0x64,%al
   0x7c0c:	test   $0x2,%al
   0x7c0e:	jne    0x7c0a
   0x7c10:	mov    $0xd1,%al
   0x7c12:	out    %al,$0x64
   0x7c14:	in     $0x64,%al
   0x7c16:	test   $0x2,%al
   0x7c18:	jne    0x7c14
   0x7c1a:	mov    $0xdf,%al
   0x7c1c:	out    %al,$0x60
   0x7c1e:	lgdtw  0x7c64
   0x7c23:	mov    %cr0,%eax
   0x7c26:	or     $0x1,%eax
   0x7c2a:	mov    %eax,%cr0
   0x7c2d:	ljmp   $0x8,$0x7c32
...
</pre>
<p>
The first few lines from 0x7c00 is just the same as code in <i>boot.S</i> .
There are some codes need to focus on.
</p>
<ol class="org-ol">
<li><p>
<code>ljmp $0x8,$0x7c32</code>
The original assembly code is <code>ljmp    $PROT_MODE_CSEG, $protcseg</code> where
<code>.set PROT_MODE_CSEG, 0x8         # kernel code segment selector</code>. 
The GDT code is:
</p>
<pre class="example">
   gdt:
     SEG_NULL                              # null seg
     SEG(STA_X|STA_R, 0x0, 0xffffffff)     # code seg
     SEG(STA_W, 0x0, 0xffffffff)           # data seg
</pre>
<p>
Here we can see that the logical addr <code>0x8</code> is mapped to <code>0x0</code>.
Therefore although we have GDT, the following code we're using is still mapped
directly to %eip.
</p></li>

<li><p>
Let's focus on bootmain next&#x2026; 
</p>
<pre class="example">
   (gdb) x/5i 0x7c40
      0x7c40:	mov    $0x7c00,%sp
      0x7c43:	add    %al,(%bx,%si)
      0x7c45:	call   0x7d13
      0x7c48:	add    %al,(%bx,%si)
      0x7c4a:	jmp    0x7c4a
</pre>
<p>
The origin is
</p>
<pre class="example">
   # Set up the stack pointer and call into C.
    movl    $start, %esp
    call bootmain

   # If bootmain returns (it shouldn't), loop.
  spin:
    jmp spin
</pre>
<p>
Since we are in assembly, we need to set %esp by hand to <code>0x7c00(function call conventions)</code>.
<code>bootmain</code> is at <code>0x7d13</code>.
</p>
<ul class="org-ul">
<li><p>
What does <code>add    %al,(%bx,%si)</code> do here?
</p>

<p>
it could be a bunch of data that the de-compiler is having trouble with&#x2026;
more likely, its just the header or footer information that comes with every executable&#x2026;
</p></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org21d3002" class="outline-4">
<h4 id="org21d3002"><span class="section-number-4">3.1.3</span> Trace bootmain and readect</h4>
<div class="outline-text-4" id="text-3-1-3">
<ul class="org-ul">
<li>bootmain code</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold;">bootmain</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">void</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
        <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">Proghdr</span> *<span style="color: #ff6347; font-weight: bold;">ph</span>, *<span style="color: #ff6347; font-weight: bold;">eph</span>;

        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">read 1st page off disk                                               </span>
        readseg<span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">uint32_t</span><span style="color: #ffa500;">)</span> ELFHDR, SECTSIZE*8, 0<span style="color: #00bfff;">)</span>;

        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">is this a valid ELF?                                                 </span>
        <span style="color: #729fcf; font-weight: bold;">if</span> <span style="color: #00bfff;">(</span>ELFHDR-&gt;e_magic != ELF_MAGIC<span style="color: #00bfff;">)</span>
                <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234; font-weight: bold;">bad</span>;

        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">load each program segment (ignores ph flags)                         </span>
        ph = <span style="color: #00bfff;">(</span><span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">Proghdr</span> *<span style="color: #00bfff;">)</span> <span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">uint8_t</span> *<span style="color: #ffa500;">)</span> ELFHDR + ELFHDR-&gt;e_phoff<span style="color: #00bfff;">)</span>;
        eph = ph + ELFHDR-&gt;e_phnum;
        <span style="color: #729fcf; font-weight: bold;">for</span> <span style="color: #00bfff;">(</span>; ph &lt; eph; ph++<span style="color: #00bfff;">)</span>
                <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">p_pa is the load address of this segment (as well            </span>
                <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">as the physical address)                                     </span>
                readseg<span style="color: #00bfff;">(</span>ph-&gt;p_pa, ph-&gt;p_memsz, ph-&gt;p_offset<span style="color: #00bfff;">)</span>;

        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">call the entry point from the ELF header                             </span>
        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">note: does not return!                                               </span>
        <span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">void</span> <span style="color: #ff7f50;">(</span>*<span style="color: #ff7f50;">)(</span><span style="color: #8ae234; font-weight: bold;">void</span><span style="color: #ff7f50;">)</span><span style="color: #ffa500;">)</span> <span style="color: #ffa500;">(</span>ELFHDR-&gt;e_entry<span style="color: #ffa500;">)</span><span style="color: #00bfff;">)()</span>;

<span style="color: #8ae234; font-weight: bold;">bad</span>:
        outw<span style="color: #00bfff;">(</span>0x8A00, 0x8A00<span style="color: #00bfff;">)</span>;
        outw<span style="color: #00bfff;">(</span>0x8A00, 0x8E00<span style="color: #00bfff;">)</span>;
        <span style="color: #729fcf; font-weight: bold;">while</span> <span style="color: #00bfff;">(</span>1<span style="color: #00bfff;">)</span>
                <span style="color: #888a85; font-style: italic;">/* </span><span style="color: #888a85; font-style: italic;">do nothing </span><span style="color: #888a85; font-style: italic;">*/</span>;
<span style="color: #ffd700;">}</span>

</pre>
</div>
<p>
Later we will figure out where the kernel will be loaded.
</p>
<pre class="example">
(gdb) x/10i 0x7d15
=&gt; 0x7d15:	push   %ebp
   0x7d16:	mov    %esp,%ebp
   0x7d18:	push   %esi
   0x7d19:	push   %ebx
   0x7d1a:	push   $0x0
   0x7d1c:	push   $0x1000
   0x7d21:	push   $0x10000
   0x7d26:	call   0x7cdc
   0x7d2b:	add    $0xc,%esp
   0x7d2e:	cmpl   $0x464c457f,0x10000
...
</pre>
<p>
The for loop checks eph range each loop.
</p>
</div>
</div>

<div id="outline-container-org86c021d" class="outline-4">
<h4 id="org86c021d"><span class="section-number-4">3.1.4</span> Questions</h4>
<div class="outline-text-4" id="text-3-1-4">
<ul class="org-ul">
<li><p>
At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode?
</p>

<p>
At the point after <code>ljmp    $PROT_MODE_CSEG, $protcseg</code>.
Change %cr0 exactly causes the switch.
</p></li>
</ul>


<ul class="org-ul">
<li><p>
What is the last instruction of the boot loader executed, and what is the first instruction of the kernel it just loaded?
</p>

<p>
Last instruction(if no fault): <code>((void (*)(void)) (ELFHDR-&gt;e_entry))();</code>.
First instruction of kernel: <code>movw $0x1234,0x472</code>.
</p></li>

<li><p>
Where is the first instruction of the kernel?
</p>

<p>
as above
</p></li>

<li><p>
How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? 
Where does it find this information?
</p>

<p>
from the variable <code>ELFHDR-&gt;e_phoff</code>.
</p></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org2e74333" class="outline-3">
<h3 id="org2e74333"><span class="section-number-3">3.2</span> Loading the kernel</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-orgeae11c7" class="outline-4">
<h4 id="orgeae11c7"><span class="section-number-4">3.2.1</span> Exercise 5</h4>
<div class="outline-text-4" id="text-3-2-1">
<blockquote>
<p>
Exercise 4. Read about programming with pointers in C. 
The best reference for the C language is The C Programming Language by Brian Kernighan and Dennis Ritchie (known as 'K&amp;R'). 
We recommend that students purchase this book (here is an Amazon Link) or find one of MIT's 7 copies.
</p>

<p>
Read 5.1 (Pointers and Addresses) through 5.5 (Character Pointers and Functions) in K&amp;R. 
Then download the code for pointers.c, run it, and make sure you understand where all of the printed values come from. 
In particular, make sure you understand where the pointer addresses in printed lines 1 and 6 come from, 
how all the values in printed lines 2 through 4 get there, and why the values printed in line 5 are seemingly corrupted.
</p>

<p>
There are other references on pointers in C (e.g., A tutorial by Ted Jensen that cites K&amp;R heavily), though not as strongly recommended.
</p>

<p>
Warning: Unless you are already thoroughly versed in C, do not skip or even skim this reading exercise. 
If you do not really understand pointers in C, you will suffer untold pain and misery in subsequent labs, 
and then eventually come to understand them the hard way. Trust us; you don't want to find out what "the hard way" is.
</p>
</blockquote>
<p>
The hard way&#x2026;emmmmm seems intereting (
</p>

<p>
I think I am already familiar with C pointers, but, just in case, Let's check knowledge by this exercise.
</p>

<p>
Code of <i>pointers.c</i>.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #729fcf;">#include</span> <span style="color: #ffd700; font-style: italic;">&lt;</span><span style="color: #ad7fa8; font-style: italic;">stdio.h</span><span style="color: #ffd700; font-style: italic;">&gt;</span>
<span style="color: #729fcf;">#include</span> <span style="color: #ffd700; font-style: italic;">&lt;</span><span style="color: #ad7fa8; font-style: italic;">stdlib.h</span><span style="color: #ffd700; font-style: italic;">&gt;</span>

<span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold;">f</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">void</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
    <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">a</span><span style="color: #00bfff;">[</span>4<span style="color: #00bfff;">]</span>;
    <span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347; font-weight: bold;">b</span> = malloc<span style="color: #00bfff;">(</span>16<span style="color: #00bfff;">)</span>;
    <span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #ff6347; font-weight: bold;">c</span>;
    <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">i</span>;

    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"1: a = %p, b = %p, c = %p\n"</span>, a, b, c<span style="color: #00bfff;">)</span>;

    c = a;
    <span style="color: #729fcf; font-weight: bold;">for</span> <span style="color: #00bfff;">(</span>i = 0; i &lt; 4; i++<span style="color: #00bfff;">)</span>
        a<span style="color: #00bfff;">[</span>i<span style="color: #00bfff;">]</span> = 100 + i;
    c<span style="color: #00bfff;">[</span>0<span style="color: #00bfff;">]</span> = 200;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"2: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span>,
           a<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span><span style="color: #00bfff;">)</span>;

    c<span style="color: #00bfff;">[</span>1<span style="color: #00bfff;">]</span> = 300;
    *<span style="color: #00bfff;">(</span>c + 2<span style="color: #00bfff;">)</span> = 301;
    3<span style="color: #00bfff;">[</span>c<span style="color: #00bfff;">]</span> = 302;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"3: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span>,
           a<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span><span style="color: #00bfff;">)</span>;

    c = c + 1;
    *c = 400;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"4: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span>,
           a<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span><span style="color: #00bfff;">)</span>;

    c = <span style="color: #00bfff;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #00bfff;">)</span> <span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ffa500;">)</span> c + 1<span style="color: #00bfff;">)</span>;
    *c = 500;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"5: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span>,
           a<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span>, a<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span><span style="color: #00bfff;">)</span>;

    b = <span style="color: #00bfff;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #00bfff;">)</span> a + 1;
    c = <span style="color: #00bfff;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #00bfff;">)</span> <span style="color: #00bfff;">(</span><span style="color: #ffa500;">(</span><span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #ffa500;">)</span> a + 1<span style="color: #00bfff;">)</span>;
    printf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"6: a = %p, b = %p, c = %p\n"</span>, a, b, c<span style="color: #00bfff;">)</span>;
<span style="color: #ffd700;">}</span>

<span style="color: #8ae234; font-weight: bold;">int</span>
<span style="color: #edd400; font-weight: bold;">main</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">ac</span>, <span style="color: #8ae234; font-weight: bold;">char</span> **<span style="color: #ff6347; font-weight: bold;">av</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
    f<span style="color: #00bfff;">()</span>;
    <span style="color: #729fcf; font-weight: bold;">return</span> 0;
<span style="color: #ffd700;">}</span>

</pre>
</div>
<p>
Result:
</p>
<pre class="example">
1: a = 0x7ffeeb8b9970, b = 0x7fcb43405800, c = 0x7ffeeb8b99d8
2: a[0] = 200, a[1] = 101, a[2] = 102, a[3] = 103
3: a[0] = 200, a[1] = 300, a[2] = 301, a[3] = 302
4: a[0] = 200, a[1] = 400, a[2] = 301, a[3] = 302
5: a[0] = 200, a[1] = 128144, a[2] = 256, a[3] = 302
6: a = 0x7ffeeb8b9970, b = 0x7ffeeb8b9974, c = 0x7ffeeb8b9971
</pre>
<p>
Well I'm done, how about u?
</p>
</div>
</div>

<div id="outline-container-org01bcaa2" class="outline-4">
<h4 id="org01bcaa2"><span class="section-number-4">3.2.2</span> ELF format</h4>
<div class="outline-text-4" id="text-3-2-2">
<ul class="org-ul">
<li><b>.text</b>: The program's executable instructions.</li>
<li><b>.rodata</b>: Read-only data, such as ASCII string constants produced by the C compiler.</li>
<li><b>.data</b>: The data section holds the program's initialized data, such as global variables declared with initializers like int x = 5;.</li>
<li><b>.bss</b>: "uninitialized" global variables start with a value of zero</li>
</ul>

<p>
Let's try this command:
</p>
<pre class="example">
$ objdump -h obj/kern/kernel
</pre>
<pre class="example">
obj/kern/kernel:     file format elf32-i386

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .text         000019e9  f0100000  00100000  00001000  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  1 .rodata       000006c0  f0101a00  00101a00  00002a00  2**5
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  2 .stab         00003b95  f01020c0  001020c0  000030c0  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  3 .stabstr      00001948  f0105c55  00105c55  00006c55  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  4 .data         00009300  f0108000  00108000  00009000  2**12
                  CONTENTS, ALLOC, LOAD, DATA
  5 .got          00000008  f0111300  00111300  00012300  2**2
                  CONTENTS, ALLOC, LOAD, DATA
  6 .got.plt      0000000c  f0111308  00111308  00012308  2**2
                  CONTENTS, ALLOC, LOAD, DATA
  7 .data.rel.local 00001000  f0112000  00112000  00013000  2**12
                  CONTENTS, ALLOC, LOAD, DATA
  8 .data.rel.ro.local 00000044  f0113000  00113000  00014000  2**2
                  CONTENTS, ALLOC, LOAD, DATA
  9 .bss          00000648  f0113060  00113060  00014060  2**5
                  CONTENTS, ALLOC, LOAD, DATA
 10 .comment      00000029  00000000  00000000  000146a8  2**0
                  CONTENTS, READONLY
</pre>
<p>
Several things to notice:
</p>
<ol class="org-ol">
<li>"VMA" (or link address) and the "LMA" (or load address) of the .text section.
VMA and LMA often the same, why not here(we will rediscuss this in the part 3).</li>
</ol>

<p>
well, just a general concept here, I shall study in-depth when I review compiler theories again.
</p>
</div>
</div>

<div id="outline-container-org9bfdf99" class="outline-4">
<h4 id="org9bfdf99"><span class="section-number-4">3.2.3</span> Exercise 5</h4>
<div class="outline-text-4" id="text-3-2-3">
<blockquote>
<p>
Trace through the first few instructions of the boot loader again and identify the first instruction that 
would "break" or otherwise do the wrong thing if you were to get the boot loader's link address wrong. 
Then change the link address in boot/Makefrag to something wrong, run make clean, recompile the lab with make, 
and trace into the boot loader again to see what happens. Don't forget to change the link address back and make clean again afterward!
</p>
</blockquote>
</div>
</div>
</div>
</div>

<div id="outline-container-org58bac30" class="outline-2">
<h2 id="org58bac30"><span class="section-number-2">4</span> Part 3: The Kernel</h2>
<div class="outline-text-2" id="text-4">
<p>
Kernel! Things going to become interesting!
Let's first try to figure out one remained question on <span class="underline">ELF format</span> above:
</p>
<blockquote>
<p>
Why VMA is different from LMA?
</p>
</blockquote>
<blockquote>
<p>
Operating system kernels often like to be linked and run at very high virtual address, such as 0xf0100000, 
in order to leave the lower part of the processor's virtual address space for user programs to use. 
The reason for this arrangement will become clearer in the next lab.
</p>
</blockquote>
<p>
In fact, OS map virtual address 0xf0100000 (the link address at which the kernel code expects to run) 
to physical address 0x00100000 (where the boot loader loaded the kernel into physical memory).
Well, it seems we still have more work to do:)
</p>
</div>

<div id="outline-container-org59edb95" class="outline-3">
<h3 id="org59edb95"><span class="section-number-3">4.1</span> Exercise 7</h3>
<div class="outline-text-3" id="text-4-1">
<blockquote>
<p>
Use QEMU and GDB to trace into the JOS kernel and stop at the movl %eax, %cr0. 
Examine memory at 0x00100000 and at 0xf0100000. 
Now, single step over that instruction using the stepi GDB command. 
Again, examine memory at 0x00100000 and at 0xf0100000. Make sure you understand what just happened.
</p>

<p>
What is the first instruction after the new mapping is established that would fail to work properly if the mapping weren't in place? 
Comment out the movl %eax, %cr0 in kern/entry.S, trace into it, and see if you were right.
</p>
</blockquote>
<pre class="example">
(gdb) b *0x10000c
Breakpoint 1 at 0x10000c
(gdb) c
Continuing.
The target architecture is assumed to be i386
=&gt; 0x10000c:	movw   $0x1234,0x472

Breakpoint 1, 0x0010000c in ?? ()
(gdb) x/4i 0x00100000
   0x100000:	add    0x1bad(%eax),%dh
   0x100006:	add    %al,(%eax)
   0x100008:	decb   0x52(%edi)
   0x10000b:	in     $0x66,%al
(gdb) x/4i 0xf0100000
   0xf0100000 &lt;_start+4026531828&gt;:	add    %al,(%eax)
   0xf0100002 &lt;_start+4026531830&gt;:	add    %al,(%eax)
   0xf0100004 &lt;_start+4026531832&gt;:	add    %al,(%eax)
   0xf0100006 &lt;_start+4026531834&gt;:	add    %al,(%eax)
</pre>

<p>
After several <code>si</code>&#x2026;
</p>
<pre class="example">
(gdb) si
=&gt; 0x100028:	mov    $0xf010002f,%eax
0x00100028 in ?? ()
(gdb) x/4i 0x00100000
   0x100000:	add    0x1bad(%eax),%dh
   0x100006:	add    %al,(%eax)
   0x100008:	decb   0x52(%edi)
   0x10000b:	in     $0x66,%al
(gdb) x/4i 0xf0100000
   0xf0100000 &lt;_start+4026531828&gt;:	add    0x1bad(%eax),%dh
   0xf0100006 &lt;_start+4026531834&gt;:	add    %al,(%eax)
   0xf0100008 &lt;_start+4026531836&gt;:	decb   0x52(%edi)
   0xf010000b &lt;_start+4026531839&gt;:	in     $0x66,%al
</pre>
<p>
Address mapping done.
</p>
</div>
</div>

<div id="outline-container-org3493dce" class="outline-3">
<h3 id="org3493dce"><span class="section-number-3">4.2</span> Formatted Printing to the Console</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-org1365bea" class="outline-4">
<h4 id="org1365bea"><span class="section-number-4">4.2.1</span> Exercise 8</h4>
<div class="outline-text-4" id="text-4-2-1">
<blockquote>
<p>
We have omitted a small fragment of code - the code necessary to print octal numbers using patterns of the form "%o". 
Find and fill in this code fragment.
</p>
</blockquote>
<p>
Well, it's easy to complete the code, but it's still alittle hard for me to understand every line here.
</p>

<ul class="org-ul">
<li><code>kern/printf.c</code> rely on <code>lib/printfmt.c</code> and <code>kern/console.c</code> .</li>
<li><code>lib/printfmt.c</code> rely on <code>kern/console.c</code> .</li>
</ul>

<p>
The most important part is here:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">output a character to the console</span>
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold;">cons_putc</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">c</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
    serial_putc<span style="color: #00bfff;">(</span>c<span style="color: #00bfff;">)</span>;
    lpt_putc<span style="color: #00bfff;">(</span>c<span style="color: #00bfff;">)</span>;
    cga_putc<span style="color: #00bfff;">(</span>c<span style="color: #00bfff;">)</span>;
<span style="color: #ffd700;">}</span>
</pre>
</div>

<p>
Let's firstly finish the code and try to analyse more codes&#x2026;
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #729fcf; font-weight: bold;">case</span> <span style="color: #ad7fa8; font-style: italic;">'o'</span>:
    num = getuint<span style="color: #ffd700;">(</span>&amp;ap, lflag<span style="color: #ffd700;">)</span>;
    base = 8;
    <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234; font-weight: bold;">number</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb274763" class="outline-4">
<h4 id="orgb274763"><span class="section-number-4">4.2.2</span> Explain the following code from <code>kern/console.c</code> .</h4>
<div class="outline-text-4" id="text-4-2-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #729fcf; font-weight: bold;">if</span> <span style="color: #ffd700;">(</span>crt_pos &gt;= CRT_SIZE<span style="color: #ffd700;">)</span> <span style="color: #ffd700;">{</span>
    <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">i</span>;
    memmove<span style="color: #00bfff;">(</span>crt_buf, crt_buf + CRT_COLS, <span style="color: #ffa500;">(</span>CRT_SIZE - CRT_COLS<span style="color: #ffa500;">)</span> * <span style="color: #729fcf; font-weight: bold;">sizeof</span><span style="color: #ffa500;">(</span>uint16_t<span style="color: #ffa500;">)</span><span style="color: #00bfff;">)</span>;
    <span style="color: #729fcf; font-weight: bold;">for</span> <span style="color: #00bfff;">(</span>i = CRT_SIZE - CRT_COLS; i &lt; CRT_SIZE; i++<span style="color: #00bfff;">)</span>
        crt_buf<span style="color: #00bfff;">[</span>i<span style="color: #00bfff;">]</span> = 0x0700 | <span style="color: #ad7fa8; font-style: italic;">' '</span>;
        crt_pos -= CRT_COLS;
<span style="color: #ffd700;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc1cc327" class="outline-3">
<h3 id="orgc1cc327"><span class="section-number-3">4.3</span> The Stack</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Exploring in more detail the way the C language uses the stack on the x86.
</p>
</div>

<div id="outline-container-org5742cc4" class="outline-4">
<h4 id="org5742cc4"><span class="section-number-4">4.3.1</span> Exercise 9</h4>
<div class="outline-text-4" id="text-4-3-1">
<blockquote>
<p>
Determine where the kernel initializes its stack, and exactly where in memory its stack is located. 
How does the kernel reserve space for its stack? And at which "end" of this reserved area is the stack pointer initialized to point to?
</p>
</blockquote>

<p>
I noticed codes in <code>kern/entry.S</code> :
</p>
<pre class="example">
.data
###################################################################
# boot stack
###################################################################
        .p2align        PGSHIFT         # force page alignment
        .globl          bootstack
bootstack:
        .space          KSTKSIZE
	.globl          bootstacktop
bootstacktop:
</pre>

<p>
and settings here:
</p>
<pre class="example">
 # Clear the frame pointer register (EBP)
 # so that once we get into debugging C code,
 # stack backtraces will be terminated properly.
 movl    $0x0,%ebp                       # nuke frame pointer

 # Set the stack pointer
 movl    $(bootstacktop),%esp
</pre>

<p>
Moreover, in <code>inc/memlayout.h</code> :
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">Kernel stack.</span>
<span style="color: #729fcf;">#define</span> <span style="color: #ff6347; font-weight: bold;">KSTACKTOP</span>    KERNBASE
<span style="color: #729fcf;">#define</span> <span style="color: #ff6347; font-weight: bold;">KSTKSIZE</span>    <span style="color: #ffd700;">(</span>8*PGSIZE<span style="color: #ffd700;">)</span>           <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">size of a kernel stack</span>
<span style="color: #729fcf;">#define</span> <span style="color: #ff6347; font-weight: bold;">KSTKGAP</span>        <span style="color: #ffd700;">(</span>8*PGSIZE<span style="color: #ffd700;">)</span>           <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">size of a kernel stack guard</span>
</pre>
</div>

<p>
<code>PGSIZE</code> is defined in <code>inc/mmu.h</code> , which is <code>4096</code> .
Thus <code>KSTKSIZE = 32KB</code> .
</p>

<p>
Before jump into exercise 10, I want to draw an overview of current memory layout.
</p>
<pre class="example">
+------------------+  &lt;- 0xFFFFFFFF (4GB)
|      32-bit      |
|  memory mapped   |
|     devices      |
|                  |
/\/\/\/\/\/\/\/\/\/\

/\/\/\/\/\/\/\/\/\/\
|                  |
|      Unused      |
|                  |
+------------------+  &lt;- depends on amount of RAM
|                  |
|------------------|  &lt;- 0x00110000 (Stack top)
|   Kernel stack   |
|------------------|  &lt;- 0x0010fc00 (end of stack)
|   Kernel codes   |
+------------------+  &lt;- 0x00100000 (1MB)
|     BIOS ROM     |
+------------------+  &lt;- 0x000F0000 (960KB)
|  16-bit devices, |
|  expansion ROMs  |
+------------------+  &lt;- 0x000C0000 (768KB)
|   VGA Display    |
+------------------+  &lt;- 0x000A0000 (640KB)
|                  |
|    Low Memory    |
|                  |
+------------------+  &lt;- 0x00000000
</pre>
</div>
</div>

<div id="outline-container-org65d6d34" class="outline-4">
<h4 id="org65d6d34"><span class="section-number-4">4.3.2</span> Exercise 10</h4>
<div class="outline-text-4" id="text-4-3-2">
<blockquote>
<p>
To become familiar with the C calling conventions on the x86, 
find the address of the test<sub>backtrace</sub> function in obj/kern/kernel.asm, 
set a breakpoint there, and examine what happens each time it gets called after the kernel starts. 
How many 32-bit words does each recursive nesting level of test<sub>backtrace</sub> push on the stack, and what are those words?
</p>

<p>
Note that, for this exercise to work properly, 
you should be using the patched version of QEMU available on the tools page or on Athena. 
Otherwise, you'll have to manually translate all breakpoint and memory addresses to linear addresses.
</p>
</blockquote>

<ul class="org-ul">
<li>Function <code>test_backtrace</code> in <code>obj/kern/kernel.asm</code> :</li>
</ul>
<pre class="example">
f0100040 &lt;test_backtrace&gt;:
</pre>
<p>
The C codes of <code>test_backtrace</code> is in <code>kern/init.c</code> :
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">Test the stack backtrace function (lab 1 only)                               </span>
<span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold;">test_backtrace</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">x</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
        cprintf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"entering test_backtrace %d\n"</span>, x<span style="color: #00bfff;">)</span>;
        <span style="color: #729fcf; font-weight: bold;">if</span> <span style="color: #00bfff;">(</span>x &gt; 0<span style="color: #00bfff;">)</span>
                test_backtrace<span style="color: #00bfff;">(</span>x-1<span style="color: #00bfff;">)</span>;
        <span style="color: #729fcf; font-weight: bold;">else</span>
                mon_backtrace<span style="color: #00bfff;">(</span>0, 0, 0<span style="color: #00bfff;">)</span>;
        cprintf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"leaving test_backtrace %d\n"</span>, x<span style="color: #00bfff;">)</span>;
<span style="color: #ffd700;">}</span>
</pre>
</div>

<p>
Register <code>%bp</code> makes stack linked.
This is a recursion function, let's test this in qemu.
Firstly, we need to implement more codes&#x2026;
</p>
</div>
</div>

<div id="outline-container-org6d6e509" class="outline-4">
<h4 id="org6d6e509"><span class="section-number-4">4.3.3</span> Exercise 11</h4>
<div class="outline-text-4" id="text-4-3-3">
<blockquote>
<p>
Implement the backtrace function as specified above. 
Use the same format as in the example, since otherwise the grading script will be confused. 
When you think you have it working right, run make grade to see if its output conforms to what our grading script expects, 
and fix it if it doesn't. 
After you have handed in your Lab 1 code, you are welcome to change the output format of the backtrace function any way you like.
</p>

<p>
If you use read<sub>ebp</sub>(), note that GCC may generate "optimized" code that 
calls read<sub>ebp</sub>() before mon<sub>backtrace</sub>()'s function prologue, 
which results in an incomplete stack trace (the stack frame of the most recent function call is missing). 
While we have tried to disable optimizations that cause this reordering, 
you may want to examine the assembly of mon<sub>backtrace</sub>() and make sure the call to read<sub>ebp</sub>() is happening after the function prologue.
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8ae234; font-weight: bold;">int</span>
<span style="color: #edd400; font-weight: bold;">mon_backtrace</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> **<span style="color: #ff6347; font-weight: bold;">argv</span>, <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">Trapframe</span> *<span style="color: #ff6347; font-weight: bold;">tf</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
        <span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">Your code here.                                                           </span>
        <span style="color: #8ae234; font-weight: bold;">uint32_t</span> <span style="color: #ff6347; font-weight: bold;">ebp</span>, <span style="color: #ff6347; font-weight: bold;">eip</span>, <span style="color: #ff6347; font-weight: bold;">args</span><span style="color: #00bfff;">[</span>5<span style="color: #00bfff;">]</span>;
        cprintf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"Stack backtrace:\n"</span><span style="color: #00bfff;">)</span>;
        <span style="color: #729fcf; font-weight: bold;">for</span><span style="color: #00bfff;">(</span>ebp = read_ebp<span style="color: #ffa500;">()</span>; ebp != 0; ebp = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uint32_t</span> *<span style="color: #ff7f50;">)</span>ebp<span style="color: #ffa500;">)</span><span style="color: #00bfff;">)</span> <span style="color: #00bfff;">{</span>
                eip = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uint32_t</span> *<span style="color: #ff7f50;">)</span>ebp + 1<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 2<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 3<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 4<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 5<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>4<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 6<span style="color: #ffa500;">)</span>;
                cprintf<span style="color: #ffa500;">(</span><span style="color: #ad7fa8; font-style: italic;">"  ebp %08x  eip %08x  args %08x %08x %08x %08x %08x\n"</span>,
                        ebp, eip, args<span style="color: #ff7f50;">[</span>0<span style="color: #ff7f50;">]</span>, args<span style="color: #ff7f50;">[</span>1<span style="color: #ff7f50;">]</span>, args<span style="color: #ff7f50;">[</span>2<span style="color: #ff7f50;">]</span>, args<span style="color: #ff7f50;">[</span>3<span style="color: #ff7f50;">]</span>, args<span style="color: #ff7f50;">[</span>4<span style="color: #ff7f50;">]</span><span style="color: #ffa500;">)</span>;
        <span style="color: #00bfff;">}</span>
        <span style="color: #729fcf; font-weight: bold;">return</span> 0;
<span style="color: #ffd700;">}</span>
</pre>
</div>
<pre class="example">
entering test_backtrace 5
entering test_backtrace 4
entering test_backtrace 3
entering test_backtrace 2
entering test_backtrace 1
entering test_backtrace 0
Stack backtrace:
  ebp f010ff18  eip f0100078  args 00000000 00000000 00000000 f010004a f0111308
  ebp f010ff38  eip f01000a1  args 00000000 00000001 f010ff78 f010004a f0111308
  ebp f010ff58  eip f01000a1  args 00000001 00000002 f010ff98 f010004a f0111308
  ebp f010ff78  eip f01000a1  args 00000002 00000003 f010ffb8 f010004a f0111308
  ebp f010ff98  eip f01000a1  args 00000003 00000004 00000000 f010004a f0111308
  ebp f010ffb8  eip f01000a1  args 00000004 00000005 00000000 f010004a f0111308
  ebp f010ffd8  eip f01000f4  args 00000005 00001aac 00000640 00000000 00000000
  ebp f010fff8  eip f010003e  args 00000003 00001003 00002003 00003003 00004003
leaving test_backtrace 0
leaving test_backtrace 1
leaving test_backtrace 2
leaving test_backtrace 3
leaving test_backtrace 4
leaving test_backtrace 5
</pre>
<p>
Done!
</p>
</div>
</div>

<div id="outline-container-org7f53a61" class="outline-4">
<h4 id="org7f53a61"><span class="section-number-4">4.3.4</span> Exercise 12</h4>
<div class="outline-text-4" id="text-4-3-4">
<blockquote>
<p>
Modify your stack backtrace function to display, for each eip, the function name, source file name, and line number corresponding to that eip.
</p>

<p>
In debuginfo<sub>eip</sub>, where do _<sub>STAB</sub><sub>*</sub> come from? This question has a long answer; to help you to discover the answer, here are some things you might want to do:
</p>

<p>
look in the file kern/kernel.ld for _<sub>STAB</sub><sub>*</sub>
run objdump -h obj/kern/kernel
run objdump -G obj/kern/kernel
run gcc -pipe -nostdinc -O2 -fno-builtin -I. -MD -Wall -Wno-format -DJOS<sub>KERNEL</sub> -gstabs -c -S kern/init.c, and look at init.s.
see if the bootloader loads the symbol table in memory as part of loading the kernel binary
Complete the implementation of debuginfo<sub>eip</sub> by inserting the call to stab<sub>binsearch</sub> to find the line number for an address.
</p>

<p>
Add a backtrace command to the kernel monitor, and extend your implementation of mon<sub>backtrace</sub> to call 
debuginfo<sub>eip</sub> and print a line for each stack frame of the form:
</p>
<pre class="example">
K&gt; backtrace
Stack backtrace:
  ebp f010ff78  eip f01008ae  args 00000001 f010ff8c 00000000 f0110580 00000000
         kern/monitor.c:143: monitor+106
  ebp f010ffd8  eip f0100193  args 00000000 00001aac 00000660 00000000 00000000
         kern/init.c:49: i386_init+59
  ebp f010fff8  eip f010003d  args 00000000 00000000 0000ffff 10cf9a00 0000ffff
         kern/entry.S:70: &lt;unknown&gt;+0
K&gt; 
</pre>
<p>
Each line gives the file name and line within that file of the stack frame's eip, 
followed by the name of the function and the offset of the eip from the first instruction of the function 
(e.g., monitor+106 means the return eip is 106 bytes past the beginning of monitor).
</p>

<p>
Be sure to print the file and function names on a separate line, to avoid confusing the grading script.
</p>

<p>
Tip: printf format strings provide an easy, albeit obscure, way to print non-null-terminated strings like those in STABS tables. 
printf("%.*s", length, string) prints at most length characters of string. Take a look at the printf man page to find out why this works.
</p>

<p>
You may find that some functions are missing from the backtrace. 
For example, you will probably see a call to monitor() but not to runcmd(). 
This is because the compiler in-lines some function calls. 
Other optimizations may cause you to see unexpected line numbers. 
If you get rid of the -O2 from GNUMakefile, the backtraces may make more sense (but your kernel will run more slowly).
</p>
</blockquote>
<p>
Let's finish lab 1!
</p>

<p>
Tracing address is not enough!
We want the function name:)
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #8ae234; font-weight: bold;">int</span>
<span style="color: #edd400; font-weight: bold;">mon_backtrace</span><span style="color: #ffd700;">(</span><span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #ff6347; font-weight: bold;">argc</span>, <span style="color: #8ae234; font-weight: bold;">char</span> **<span style="color: #ff6347; font-weight: bold;">argv</span>, <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">Trapframe</span> *<span style="color: #ff6347; font-weight: bold;">tf</span><span style="color: #ffd700;">)</span>
<span style="color: #ffd700;">{</span>
        <span style="color: #8ae234; font-weight: bold;">uint32_t</span> <span style="color: #ff6347; font-weight: bold;">ebp</span>, <span style="color: #ff6347; font-weight: bold;">eip</span>, <span style="color: #ff6347; font-weight: bold;">args</span><span style="color: #00bfff;">[</span>5<span style="color: #00bfff;">]</span>;
        <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">Eipdebuginfo</span> <span style="color: #ff6347; font-weight: bold;">info</span>;
        cprintf<span style="color: #00bfff;">(</span><span style="color: #ad7fa8; font-style: italic;">"Stack backtrace:\n"</span><span style="color: #00bfff;">)</span>;
        <span style="color: #729fcf; font-weight: bold;">for</span><span style="color: #00bfff;">(</span>ebp = read_ebp<span style="color: #ffa500;">()</span>; ebp != 0; ebp = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uint32_t</span> *<span style="color: #ff7f50;">)</span>ebp<span style="color: #ffa500;">)</span><span style="color: #00bfff;">)</span> <span style="color: #00bfff;">{</span>
                eip = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uint32_t</span> *<span style="color: #ff7f50;">)</span>ebp + 1<span style="color: #ffa500;">)</span>;
                debuginfo_eip<span style="color: #ffa500;">(</span>eip, &amp;info<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>0<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 2<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>1<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 3<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>2<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 4<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>3<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 5<span style="color: #ffa500;">)</span>;
                args<span style="color: #ffa500;">[</span>4<span style="color: #ffa500;">]</span> = *<span style="color: #ffa500;">(</span><span style="color: #ff7f50;">(</span><span style="color: #8ae234; font-weight: bold;">uintptr_t</span> *<span style="color: #ff7f50;">)</span>ebp + 6<span style="color: #ffa500;">)</span>;
                cprintf<span style="color: #ffa500;">(</span><span style="color: #ad7fa8; font-style: italic;">"  ebp %08x  eip %08x  args %08x %08x %08x %08x %08x\n"</span>,
                        ebp, eip, args<span style="color: #ff7f50;">[</span>0<span style="color: #ff7f50;">]</span>, args<span style="color: #ff7f50;">[</span>1<span style="color: #ff7f50;">]</span>, args<span style="color: #ff7f50;">[</span>2<span style="color: #ff7f50;">]</span>, args<span style="color: #ff7f50;">[</span>3<span style="color: #ff7f50;">]</span>, args<span style="color: #ff7f50;">[</span>4<span style="color: #ff7f50;">]</span><span style="color: #ffa500;">)</span>;
                cprintf<span style="color: #ffa500;">(</span><span style="color: #ad7fa8; font-style: italic;">"      %s:%d: %.*s+%d\n"</span>, info.eip_file, info.eip_line,
                        info.eip_fn_namelen, info.eip_fn_name, eip - info.eip_fn_addr<span style="color: #ffa500;">)</span>;
        <span style="color: #00bfff;">}</span>
        <span style="color: #729fcf; font-weight: bold;">return</span> 0;
<span style="color: #ffd700;">}</span>
</pre>
</div>
<p>
plumb into <code>kern/kdebug.c</code> :
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #888a85; font-style: italic;">// </span><span style="color: #888a85; font-style: italic;">Your code here.                                                                                                                                      </span>
<span style="color: #edd400; font-weight: bold;">stab_binsearch</span><span style="color: #ffd700;">(</span>stabs, &amp;lline, &amp;rline, N_SLINE, addr<span style="color: #ffd700;">)</span>;
<span style="color: #729fcf; font-weight: bold;">if</span><span style="color: #ffd700;">(</span>lline &lt;= rline<span style="color: #ffd700;">)</span> <span style="color: #ffd700;">{</span>
    info-&gt;eip_line = stabs<span style="color: #00bfff;">[</span>lline<span style="color: #00bfff;">]</span>.n_desc;
<span style="color: #ffd700;">}</span>
<span style="color: #729fcf; font-weight: bold;">else</span> info-&gt;eip_line = -1;
</pre>
</div>

<p>
Have a test:
</p>
<pre class="example">
Stack backtrace:
  ebp f010ff18  eip f0100078  args 00000000 00000000 00000000 f010004a f0111308
      kern/init.c:18: test_backtrace+56
  ebp f010ff38  eip f01000a1  args 00000000 00000001 f010ff78 f010004a f0111308
      kern/init.c:16: test_backtrace+97
  ebp f010ff58  eip f01000a1  args 00000001 00000002 f010ff98 f010004a f0111308
      kern/init.c:16: test_backtrace+97
  ebp f010ff78  eip f01000a1  args 00000002 00000003 f010ffb8 f010004a f0111308
      kern/init.c:16: test_backtrace+97
  ebp f010ff98  eip f01000a1  args 00000003 00000004 00000000 f010004a f0111308
      kern/init.c:16: test_backtrace+97
  ebp f010ffb8  eip f01000a1  args 00000004 00000005 00000000 f010004a f0111308
      kern/init.c:16: test_backtrace+97
  ebp f010ffd8  eip f01000f4  args 00000005 00001aac 00000640 00000000 00000000
      kern/init.c:39: i386_init+78
  ebp f010fff8  eip f010003e  args 00000003 00001003 00002003 00003003 00004003
      kern/entry.S:83: &lt;unknown&gt;+0
</pre>

<p>
The last thing, add command to qemu repl:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #729fcf; font-weight: bold;">struct</span> <span style="color: #8ae234; font-weight: bold;">Command</span> <span style="color: #ff6347; font-weight: bold;">commands</span><span style="color: #ffd700;">[]</span> = <span style="color: #ffd700;">{</span>
    <span style="color: #00bfff;">{</span> <span style="color: #ad7fa8; font-style: italic;">"help"</span>, <span style="color: #ad7fa8; font-style: italic;">"Display this list of commands"</span>, mon_help <span style="color: #00bfff;">}</span>,
    <span style="color: #00bfff;">{</span> <span style="color: #ad7fa8; font-style: italic;">"kerninfo"</span>, <span style="color: #ad7fa8; font-style: italic;">"Display information about the kernel"</span>, mon_kerninfo <span style="color: #00bfff;">}</span>,
    <span style="color: #00bfff;">{</span> <span style="color: #ad7fa8; font-style: italic;">"backtrace"</span>, <span style="color: #ad7fa8; font-style: italic;">"Display a listing of function call frames"</span>, mon_backtrace<span style="color: #00bfff;">}</span>
<span style="color: #ffd700;">}</span>;
</pre>
</div>
<p>
Done!
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org4e9f341" class="outline-2">
<h2 id="org4e9f341"><span class="section-number-2">5</span> Epilogue</h2>
<div class="outline-text-2" id="text-5">
<p>
Have a grade!
</p>
<pre class="example">
$ make grade
</pre>
<pre class="example">
make[1]: Leaving directory '/home/comcx/MIT6.828/lab'
running JOS: (0.5s) 
  printf: OK 
  backtrace count: OK 
  backtrace arguments: OK 
  backtrace symbols: OK 
  backtrace lines: OK 
Score: 50/50
</pre>
<p>
Done!
</p>

<p>
There left some challenges to do,
See u later:)
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Comcx</p>
<p class="date">Created: 2020-06-29 Mon 23:52</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
